import{f as y}from"./dateUtil-E1W9AnjJ.js";import{c as s,G as p,eo as S,a8 as O,d as k,r as C,b as F,n as P,q as T,E as m,F as w,K as D,aY as N,N as L,A as z}from"./index-B8Pm80oX.js";import{I as R}from"./index-CfCbjZdA.js";import{T as f}from"./index-Qnpm0yEw.js";import{P as B}from"./index-BRG9fhiq.js";import{_ as G}from"./index.vue_vue_type_style_index_0_lang-CFuk3e67.js";import{u as $}from"./dynamic-table-D22kRkZE.js";import"./ApiSelect.vue_vue_type_script_setup_true_lang-CofY2-NC.js";import"./dayjs.min-TeQhONF1.js";import{_ as j}from"./index-7FjZkepP.js";import{_ as K}from"./index-DhL-eOiI.js";import{_ as M}from"./index-BBmxHBNL.js";let o=function(e){return e.SUCCESS="success",e.ERROR="error",e.UPLOADING="uploading",e}({});const oe=[{title:"文件名",dataIndex:"name",width:150,ellipsis:!0,customRender({record:e}){return s(O,null,{title:()=>e.path,default:()=>s("a",{href:S+e.path,target:"_blank"},[e.name])})}},{title:"预览图",dataIndex:"path",width:150,customRender({record:e}){return s(R,{src:S+e.path},null)}},{title:"文件后缀",dataIndex:"extName",width:80},{title:"类别",dataIndex:"type",width:80},{title:"大小",dataIndex:"size",width:80,customRender:({record:e})=>s(f,{color:"blue"},{default:()=>[e.size]})},{title:"上传者",dataIndex:"username",width:120},{title:"创建时间",dataIndex:"createdAt",width:160,customRender:({record:e})=>y(e.createdAt)}],V=[{dataIndex:"thumbUrl",title:"缩略图",width:100,customRender:({record:e})=>{const{thumbUrl:u}=e;return u&&s(R,{src:u},null)}},{dataIndex:"name",title:"文件名",align:"left",customRender:({text:e,record:u})=>{const{percent:_,status:d}=u||{};let l="normal";return d===o.ERROR?l="exception":d===o.UPLOADING?l="active":d===o.SUCCESS&&(l="success"),s("div",null,[s("p",{class:"truncate mb-1 max-w-[280px]",title:e},[e]),s(B,{percent:_,size:"small",status:l},null)])}},{dataIndex:"size",title:"文件大小",width:100,customRender:({text:e=0})=>e&&`${(e/1024).toFixed(2)}KB`},{dataIndex:"status",title:"状态",width:100,customRender:({text:e})=>e===o.SUCCESS?s(f,{color:"green"},{default:()=>[p("上传成功")]}):e===o.ERROR?s(f,{color:"red"},{default:()=>[p("上传失败")]}):e===o.UPLOADING?s(f,{color:"blue"},{default:()=>[p("上传中")]}):e||"待上传"}],ne=[{field:"name",label:"名称",component:"Input",colProps:{span:8}}],le=k({__name:"upload-modal",emits:["uploadSuccess"],setup(e,{emit:u}){const _=u,[d]=$(),l=C(!1),r=C([]),I=F(()=>!r.value.some(a=>a.status!==o.SUCCESS)),U=a=>{const{promise:t,resolve:n,reject:c}=Promise.withResolvers(),i=new FileReader;return i.onload=()=>{n(i.result)},i.onerror=b=>{c(b)},i.readAsDataURL(a),t},v=()=>{r.value.some(t=>t.status===o.SUCCESS)&&_("uploadSuccess"),r.value=[]},x=async()=>{const a=r.value.filter(t=>t.status!==o.SUCCESS);await Promise.all(a.map(async t=>{try{await N.toolsUpload.uploadUpload({file:t.file},void 0,{onUploadProgress(n){const c=n.loaded/n.total*100|0;t.percent=c,t.status=o.UPLOADING}}),t.status=o.SUCCESS}catch(n){console.log(n),t.status=o.ERROR}}))},E=async a=>{if(a.size/1024/1024>2)L.error("单个文件不超过2MB");else{const t={file:a,uid:a.uid,name:a.name,size:a.size,status:"",percent:0,thumbUrl:await U(a)};r.value.push(t)}return!1},g=a=>{r.value=r.value.filter(t=>t.uid!==a.uid)},A=[...V,{width:120,title:"操作",dataIndex:"ACTION",fixed:!1,actions:({record:a})=>[{label:"删除",color:"red",onClick:()=>g(a)}]}];return(a,t)=>{const n=z("a-button"),c=j,i=K,b=M;return P(),T(D,null,[s(n,{type:"primary",disabled:!a.$auth("upload:upload"),onClick:t[0]||(t[0]=h=>l.value=!0)},{default:m(()=>t[2]||(t[2]=[p(" 上传 ")])),_:1},8,["disabled"]),s(w(G),{open:l.value,"onUpdate:open":t[1]||(t[1]=h=>l.value=h),title:"上传",width:800,"ok-text":"开始上传","ok-button-props":{disabled:I.value},onOk:x,onCancel:v},{default:m(()=>[s(b,{justify:"space-between",align:"center"},{default:m(()=>[s(c,{message:"单个文件不超过2MB，最多只能上传10个文件",type:"info","show-icon":""}),s(i,{multiple:!0,"before-upload":E,"show-upload-list":!1},{default:m(()=>[s(n,{type:"primary"},{default:m(()=>t[3]||(t[3]=[p(" 选择文件 ")])),_:1})]),_:1})]),_:1}),s(w(d),{search:!1,"data-source":r.value,columns:A},null,8,["data-source"])]),_:1},8,["open","ok-button-props"])],64)}}});export{le as _,oe as b,ne as s};
